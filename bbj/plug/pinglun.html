<?php


$configFile = '../application/database.php';
if (!file_exists($configFile)) {
	die('无法找到数据库配置文件,请在mac中找到配置数据库信息的文件');
}
$config = include $configFile;
$servername = $config['hostname'];
$port = $config['hostport'];
$username = $config['username'];
$password = $config['password'];
$dbname = $config['database'];
$dbtable = $config['prefix'];
$conn = new mysqli($servername, $username, $password, $dbname,$port);
// 获取协议
$protocol = isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https://' : 'http://';
// 获取主机名
$host = $_SERVER['HTTP_HOST'];
// 获取当前链接
$currentLink = $protocol . $host . $_SERVER['REQUEST_URI'];
if ($conn->connect_error) {
	die("连接数据库失败: " . $conn->connect_error);
}
$type = $_GET['type'];
$page = $_GET['page'];
$force = $_GET['force'];
if($page==null) {
	$page=0;
}
;
$totalCount=0;
$userCount=1;
if($type=="day") {
	// 当前日期
	$currentDate = date("Y-m-d");
	// 当日开始时间戳
	$startTimestamp = strtotime($currentDate);
	// 当日结束时间戳
	$endTimestamp = strtotime($currentDate . " 23:59:59");
	$sql="select count(1) as total from {$dbtable}vod where vod_time >= $startTimestamp AND vod_time <= $endTimestamp";
	$result = $conn->query($sql);
	if ($result) {
		// 获取总记录数
		$row = $result->fetch_assoc();
		$totalCount = $row["total"];
		echo "当前任务 " . $totalCount . " 条\t";
	}
	echo "1/1\t采集地址{$currentLink}<br>";
	if($force==null&&$totalCount>20) {
		$properurl=$protocol.$host.$_SERVER['PHP_SELF'].'?type=all&page=0'."&statu=".$_GET['statu']."&num=".$_GET['num']."&Dmin=".$_GET['Dmin']."&Dmax=".$_GET['Dmax']."&Cmin=".$_GET['Cmin']."&Cmax=".$_GET['Cmax']."&Cip=".$_GET['Cip']."&filder=".$_GET['filder'];;
		$forceurl=$protocol.$host.$_SERVER['PHP_SELF'].'?type='.$type .'&force=on'."&statu=".$_GET['statu']."&num=".$_GET['num']."&Dmin=".$_GET['Dmin']."&Dmax=".$_GET['Dmax']."&Cmin=".$_GET['Cmin']."&Cmax=".$_GET['Cmax']."&Cip=".$_GET['Cip']."&filder=".$_GET['filder'];;
		echo "<br>今日新增数据较多，建议依次更新每条数据<a href='".$properurl."'>开始依次更新所有数据</a><br>";
		echo "无视今日数据量，强制更新今日所有数据，时间会有点长<a href='".$forceurl."'>开始强制更新今日数据</a><br>";
		echo "每日自动更新评论库,复制此链接创建定时任务<a href='".$forceurl."'>定时任务自动更新评论库链接，右键复制此链接</a><br>";
	}else{
		$force='on';
	}
	if($force=='on') {
		$sql="select count(1) as total from {$dbtable}user";
			$result = $conn->query($sql);
		if ($result) {
			$row = $result->fetch_assoc();
			$userCount = $row["total"];
		}
		$sql = "SELECT * FROM {$dbtable}vod WHERE vod_time >= $startTimestamp AND vod_time <= $endTimestamp";
		// 执行查询
		$result = $conn->query($sql);
		$sqlindex = 0;
		// 检查查询结果
		if ($result->num_rows > 0) {
			// 输出查询结果
			while ($row = $result->fetch_assoc()) {
				$sqlindex++;
				echo $sqlindex."、".$row["vod_name"]."\t";
				if($row["vod_douban_id"]==0) {
					echo "<span style='color: red;'>不存在豆瓣信息，跳过更新</span><br>";
					continue;
				}
				$sql = "SELECT count(1) as total FROM {$dbtable}comment where comment_rid='{$row["vod_id"]}'";
				$pinglunResult = $conn->query($sql);
				if ($pinglunResult) {
					// 获取总记录数
					$rows = $pinglunResult->fetch_assoc();
					$pinglunCount = $rows["total"];
					if($pinglunCount>0) {
						echo "<span style='color: red;'>已存在评论，跳过更新</span><br>";
						continue;
					}
				}
							$randomUid = rand(1, $userCount);
				$url = "https://dm.bbj.icu/pinglun/list?doubanid=".$row["vod_douban_id"]."&vodId=".$row["vod_id"] ."&dbtable={$dbtable}"."&statu=".$_GET['statu']."&num=".$_GET['num']."&Dmin=".$_GET['Dmin']."&Dmax=".$_GET['Dmax']."&Cmin=".$_GET['Cmin']."&Cmax=".$_GET['Cmax']."&Cip=".$_GET['Cip']."&filder=".$_GET['filder']."&uid=".$randomUid;
				// echo $url."<br>";

					$sqlData = file_get_contents($url,false,null);

				if($sqlData==null) {
					echo "无需更新<br>";
				} else {
					// 执行返回的 SQL 数据
					$resultData=mysqli_multi_query($conn, $sqlData);
					if ($resultData) {
						echo "<span style='color: green;'>更新成功</span><br>";
					} else {
						echo "<span style='color: red;'>更新失败" . mysqli_error($conn)."</span><br>";
					}
					// 逐个处理结果集并释放
					do {
						if ($resulttmep = mysqli_store_result($conn)) {
							// 处理结果集
							mysqli_free_result($resulttmep);
						}
					}
					while (mysqli_next_result($conn));
				}
			}
		} else {
			echo "今日无新增数据<br>";
		}
	}
} else {
	$sql="select count(1) as total from {$dbtable}user";
		$result = $conn->query($sql);
	if ($result) {
		$row = $result->fetch_assoc();
		$userCount = $row["total"];
	}
	
	$sql = "SELECT count(1) as total FROM {$dbtable}vod";
	$result = $conn->query($sql);
	if ($result) {
		// 获取总记录数
		$row = $result->fetch_assoc();
		$totalCount = $row["total"];
		echo "当前任务 " . $totalCount . " 条\t";
	}
	$pageselect=$page*20;
	$sql = "SELECT * FROM {$dbtable}vod  order by vod_id asc limit ".$pageselect.",20";
	echo $page."/".$totalCount/20;
	echo "\t采集地址{$currentLink}<br>";
	// 执行查询
	$result = $conn->query($sql);
	$sqlindex = 0;
	if ($result->num_rows > 0) {
		// 输出查询结果
		while ($row = $result->fetch_assoc()) {
			$sqlindex++;
			echo $sqlindex."、".$row["vod_name"]."\t";
			if($row["vod_douban_id"]==0) {
				echo "<span style='color: red;'>不存在豆瓣信息，跳过更新</span><br>";
				continue;
			}
			$sql = "SELECT count(1) as total FROM {$dbtable}comment where comment_rid='{$row["vod_id"]}'";
			$pinglunResult = $conn->query($sql);
			if ($pinglunResult) {
				// 获取总记录数
				$rows = $pinglunResult->fetch_assoc();
				$pinglunCount = $rows["total"];
				if($pinglunCount>0) {
					echo "<span style='color: red;'>已存在评论，跳过更新</span><br>";
					continue;
				}
			}
			$randomUid = rand(1, $userCount);
			$url = "https://dm.bbj.icu/pinglun/list?doubanid=".$row["vod_douban_id"]."&vodId=".$row["vod_id"] ."&dbtable={$dbtable}"."&statu=".$_GET['statu']."&num=".$_GET['num']."&Dmin=".$_GET['Dmin']."&Dmax=".$_GET['Dmax']."&Cmin=".$_GET['Cmin']."&Cmax=".$_GET['Cmax']."&Cip=".$_GET['Cip']."&filder=".$_GET['filder']."&uid=".$randomUid;
			// echo $url."<br>";

				$sqlData = file_get_contents($url,false,null);

			if($sqlData==null) {
				echo "无需更新<br>";
			} else {
				// 执行返回的 SQL 数据
				$resultData=mysqli_multi_query($conn, $sqlData);
				if ($resultData) {
					echo "<span style='color: green;'>更新成功</span><br>";
				} else {
					echo "<span style='color: red;'>更新失败" . mysqli_error($conn)."</span><br>";
				}
				// 逐个处理结果集并释放
				do {
					if ($resulttmep = mysqli_store_result($conn)) {
						// 处理结果集
						mysqli_free_result($resulttmep);
					}
				}
				while (mysqli_next_result($conn));
			}
		}
	}
	if($pageselect>$totalCount) {
		echo "更新结束";
	} else {
		$nexturl=$protocol.$host.$_SERVER['PHP_SELF'].'?type='.$type .'&page='.($page+1);
		// echo $nexturl;
		echo "暂停3秒后继续>>><a  style='cursor: pointer;text-decoration: underline;color:purple' >如果您的浏览器没有自动跳转，请点击这里</a>";
		echo '<script>
	setTimeout(function() {
	   window.location.href = "'.$nexturl.'";
	}, 3000);
	</script>';
	}
}
$conn->close();

		echo "<br><br>评论已成功更新，请到自己的官网查看。<br>本插件由<a href='https://bbj.icu' target='_blank'>www.bbj.icu</a>公益开发，开源插件不含任何后门代码，<a
	target='_blank'
	href='https://qm.qq.com/cgi-bin/qm/qr?k=PZZCQ_6Dq8b5tx1BQpfLCr1hj3dpzTYj&jump_from=webapi&authKey=PIfhNlDLatiiojef4DioNX/uzmRdcamr1BjENIbJXMoc6tJiXFOnpcsE+ImFUK8Q'><img
		border='0' src='//pub.idqqimg.com/wpa/images/group.png' alt='BB机海报' title='BB机海报'>784409031</a>";

?>
